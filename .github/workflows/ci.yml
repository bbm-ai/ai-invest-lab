<<<<<<< HEAD
name: CI

on:
  push:
    branches: [ "main" ]
    tags:     [ "v*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      day:
        description: "Target day for E2E (YYYY-MM-DD)"
        required: false
        default: "2025-11-08"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  # 讓 Python 模組能匯入 src/*
  PYTHONPATH: "."
  # 預設時區（你的系統用 ET；CI 可不依賴）
  TZ: "UTC"

jobs:
  verify:
    name: Verify (E2E)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'data/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install system deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sqlite3

      - name: Install Python deps
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f data/requirements.txt ]; then pip install -r data/requirements.txt; fi

      # 可選：注入秘密，若未設也不會中斷（你的腳本會記錄 SKIP）
      - name: Export API Keys (optional)
        run: |
          echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> $GITHUB_ENV
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_ENV
          echo "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}" >> $GITHUB_ENV

      - name: Make scripts executable (defensive)
        run: chmod +x scripts/*.sh || true

      - name: Bootstrap DB & Migrations
        run: bash scripts/ci_bootstrap.sh

      - name: Run E2E verify
        env:
          # 允許覆蓋；否則用 dispatch 的輸入或預設
          TARGET_DAY: ${{ inputs.day }}
        run: |
          DAY="${TARGET_DAY:-${{ github.event.inputs.day || '2025-11-08' }}}"
          echo "[CI] E2E target day -> ${DAY}"
          chmod +x scripts/e2e_m2_verify.sh || true
          bash scripts/e2e_m2_verify.sh "${DAY}"

      - name: Generate 24h Ops Report (artifact)
        run: |
          python scripts/report_ops_24h.py || true

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ github.run_id }}
          path: |
            reports/**/*.md
            reports/*.md
          if-no-files-found: ignore

  release:
    name: Release (tag)
    needs: verify
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write   # 發佈 GitHub Release 需要
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 讓腳本能讀到 tag / history

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'data/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install system deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sqlite3

      - name: Install Python deps
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f data/requirements.txt ]; then pip install -r data/requirements.txt; fi

      - name: Make scripts executable
        run: chmod +x scripts/*.sh || true

      - name: Bootstrap DB (for report regeneration)
        run: bash scripts/ci_bootstrap.sh

      - name: Build & Publish Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 若有需要，帶上 API Key；沒有也不阻塞
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          bash scripts/make_release.sh


=======
name: CI

on:
  push:
    branches: [ "main" ]
    tags:     [ "v*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      day:
        description: "Target day for E2E (YYYY-MM-DD)"
        required: false
        default: "2025-11-08"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  # 讓 Python 模組能匯入 src/*
  PYTHONPATH: "."
  # 預設時區（你的系統用 ET；CI 可不依賴）
  TZ: "UTC"

jobs:
  verify:
    name: Verify (E2E)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'data/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install system deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sqlite3

      - name: Install Python deps
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f data/requirements.txt ]; then pip install -r data/requirements.txt; fi

      # 可選：注入秘密，若未設也不會中斷（你的腳本會記錄 SKIP）
      - name: Export API Keys (optional)
        run: |
          echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> $GITHUB_ENV
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_ENV
          echo "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}" >> $GITHUB_ENV

      - name: Make scripts executable (defensive)
        run: chmod +x scripts/*.sh || true

      - name: Bootstrap DB & Migrations
        run: bash scripts/ci_bootstrap.sh

      - name: Run E2E verify
        env:
          # 允許覆蓋；否則用 dispatch 的輸入或預設
          TARGET_DAY: ${{ inputs.day }}
        run: |
          DAY="${TARGET_DAY:-${{ github.event.inputs.day || '2025-11-08' }}}"
          echo "[CI] E2E target day -> ${DAY}"
          chmod +x scripts/e2e_m2_verify.sh || true
          bash scripts/e2e_m2_verify.sh "${DAY}"

      - name: Generate 24h Ops Report (artifact)
        run: |
          python scripts/report_ops_24h.py || true

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ github.run_id }}
          path: |
            reports/**/*.md
            reports/*.md
          if-no-files-found: ignore

  release:
    name: Release (tag)
    needs: verify
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write   # 發佈 GitHub Release 需要
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 讓腳本能讀到 tag / history

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'data/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install system deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sqlite3

      - name: Install Python deps
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f data/requirements.txt ]; then pip install -r data/requirements.txt; fi

      - name: Make scripts executable
        run: chmod +x scripts/*.sh || true

      - name: Bootstrap DB (for report regeneration)
        run: bash scripts/ci_bootstrap.sh

      - name: Build & Publish Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 若有需要，帶上 API Key；沒有也不阻塞
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          bash scripts/make_release.sh
>>>>>>> 5566d45 (ci: add GitHub Actions workflow (bootstrap DB + E2E + release))
