name: QQQ Daily Analysis

on:
  # å®šæ™‚åŸ·è¡Œ
  # UTC 14:30 = å°åŒ—æ™‚é–“ 22:30
  # UTC 14:35 = å°åŒ—æ™‚é–“ 22:35 (å‚™ç”¨ï¼ŒéŒ¯é–‹å°–å³°)
  schedule:
    - cron: '30 14 * * 1-5'  # é€±ä¸€åˆ°é€±äº” 22:30 å°åŒ—æ™‚é–“
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼æ¸¬è©¦
  workflow_dispatch:
    inputs:
      risk_preference:
        description: 'é¢¨éšªåå¥½'
        required: false
        default: 'neutral'
        type: choice
        options:
          - conservative
          - neutral
          - aggressive

env:
  PYTHON_VERSION: '3.11'

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      # 1. å–å¾—ç¨‹å¼ç¢¼
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # 2. è¨­å®š Python
      - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'python/requirements.txt'
      
      # 3. å®‰è£ä¾è³´
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r python/requirements.txt
      
      # 4. åŸ·è¡Œåˆ†æ
      - name: ğŸš€ Run QQQ Analysis
        env:
          GAS_URL: ${{ secrets.GAS_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RISK_PREFERENCE: ${{ github.event.inputs.risk_preference || 'neutral' }}
        working-directory: python
        run: python qqq_analyzer.py
      
      # 5. ä¸Šå‚³çµæœ
      - name: ğŸ“¤ Upload analysis result
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: analysis-${{ github.run_number }}-${{ github.run_attempt }}
          path: python/output.json
          retention-days: 90
      
      # 6. å»ºç«‹ Summary
      - name: ğŸ“Š Create Job Summary
        if: success()
        working-directory: python
        run: |
          if [ -f output.json ]; then
            echo "## ğŸ“Š QQQ åˆ†æçµæœ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| é …ç›® | æ•¸å€¼ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| æ—¥æœŸ | $(jq -r '.date' output.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| æ”¶ç›¤åƒ¹ | \$$(jq -r '.market_data.close' output.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| æ¼²è·Œ | $(jq -r '.market_data.change_pct' output.json)% |" >> $GITHUB_STEP_SUMMARY
            echo "| è©•åˆ† | $(jq -r '.scoring.total_score' output.json)/10 |" >> $GITHUB_STEP_SUMMARY
            echo "| ç‹€æ…‹ | $(jq -r '.scoring.regime' output.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| QQQ é…ç½® | $(jq -r '.allocation.qqq_pct' output.json)% |" >> $GITHUB_STEP_SUMMARY
            echo "| VIX | $(jq -r '.market_data.vix' output.json) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… åˆ†æå®Œæˆæ–¼ $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          fi

  # é¢¨æ§ç›£æ§ (é¸ç”¨)
  risk-check:
    runs-on: ubuntu-latest
    needs: analyze
    if: always()
    
    steps:
      - name: ğŸ“¥ Download analysis result
        uses: actions/download-artifact@v4
        with:
          name: analysis-${{ github.run_number }}-${{ github.run_attempt }}
          path: ./
      
      - name: âš ï¸ Check risk alerts
        run: |
          if [ -f output.json ]; then
            TRIGGERED=$(jq -r '.risk_management.triggered' output.json)
            VIX=$(jq -r '.market_data.vix' output.json)
            
            if [ "$TRIGGERED" = "true" ]; then
              echo "::warning::é¢¨æ§è­¦å ±è§¸ç™¼ï¼VIX: $VIX"
            else
              echo "âœ… ç„¡é¢¨æ§è­¦å ±"
            fi
          fi
