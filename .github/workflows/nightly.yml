name: Nightly Build & Draft Release

on:
  workflow_dispatch:
    inputs:
      run_day:
        description: "Strategy day in America/New_York (YYYY-MM-DD). Leave empty for yesterday."
        required: false
        default: ""
  schedule:
    # 每天 06:10 UTC 執行（等於 ET 前一日深夜/隔日清晨；你可調整）
    - cron: "10 6 * * *"

env:
  TZ: America/New_York
  PYTHONUNBUFFERED: "1"

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install system deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sqlite3

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Resolve target DAY (America/New_York)
        id: day
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.run_day }}" ]; then
            DAY="${{ github.event.inputs.run_day }}"
          else
            DAY="$(TZ=America/New_York date -d 'yesterday' +%F)"
          fi
          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "[info] DAY=$DAY"

      - name: Run E2E (Milestone 2 verify to ensure pipeline health)
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          chmod +x scripts/e2e_m2_verify.sh || true
          ./scripts/e2e_m2_verify.sh "${{ steps.day.outputs.day }}"

      - name: Re-generate ops & backtest reports
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python scripts/report_ops_24h.py || true
          python scripts/backtest_runner.py || true
          python scripts/generate_final_report.py || true
          ls -l reports || true

      - name: Build artifact & create Draft Release (via make_release.sh)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # 內建自動提供，供 gh CLI 使用
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          chmod +x scripts/make_release.sh
          ./scripts/make_release.sh

      - name: Upload artifact to Actions
        uses: actions/upload-artifact@v4
        with:
          name: nightly-artifacts
          path: |
            release_*.zip
            release_v*.zip
            reports/*.md
          if-no-files-found: ignore
