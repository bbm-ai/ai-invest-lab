name: QQQ Parameter Optimization (Fixed)

on:
  # æ¯æœˆç¬¬ä¸€å€‹é€±å…­åŸ·è¡Œ
  schedule:
    - cron: '0 10 1-7 * 6'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      strategy:
        description: 'ç­–ç•¥ (ma20, default, all)'
        required: false
        default: 'all'
      days:
        description: 'å›æ¸¬å¤©æ•¸'
        required: false
        default: '60'
      dry_run:
        description: 'æ¨¡æ“¬åŸ·è¡Œ (true/false)'
        required: false
        default: 'false'

jobs:
  optimize:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ” Run optimization
        env:
          GAS_URL: ${{ secrets.GAS_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STRATEGY="${{ github.event.inputs.strategy || 'all' }}"
          DAYS="${{ github.event.inputs.days || '60' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          
          if [ "$DRY_RUN" == "true" ]; then
            python auto_optimize.py --strategy $STRATEGY --days $DAYS --dry-run
          else
            python auto_optimize.py --strategy $STRATEGY --days $DAYS
          fi
      
      - name: ğŸ“Š Generate optimization report
        if: success()
        run: |
          echo "# Optimization Report" > optimization_report.md
          echo "" >> optimization_report.md
          echo "**Date:** $(date)" >> optimization_report.md
          echo "**Strategy:** ${{ github.event.inputs.strategy || 'all' }}" >> optimization_report.md
          echo "**Days:** ${{ github.event.inputs.days || '60' }}" >> optimization_report.md
          echo "**Dry Run:** ${{ github.event.inputs.dry_run || 'false' }}" >> optimization_report.md
          echo "" >> optimization_report.md
          
          if [ -f "optimization_results.json" ]; then
            echo "## Results" >> optimization_report.md
            echo '```json' >> optimization_report.md
            cat optimization_results.json >> optimization_report.md
            echo '```' >> optimization_report.md
          fi
          
          if [ -f "optimized_params.json" ]; then
            echo "" >> optimization_report.md
            echo "## Updated Parameters" >> optimization_report.md
            echo '```json' >> optimization_report.md
            cat optimized_params.json >> optimization_report.md
            echo '```' >> optimization_report.md
          fi
      
      - name: ğŸ’¾ Upload optimization results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: optimization-results-${{ github.run_number }}
          path: |
            optimized_params.json
            optimization_results.json
            *.log
            optimization_report.md
          retention-days: 90
      
      - name: ğŸ“‹ Create Pull Request
        if: ${{ github.event.inputs.dry_run != 'true' && success() }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ğŸ¤– Update optimized parameters'
          committer: 'github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>'
          author: 'github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>'
          branch: optimization-${{ github.run_number }}
          delete-branch: true
          title: 'ğŸ¤– Parameter Optimization Results - Run ${{ github.run_number }}'
          body: |
            ## ğŸ¯ åƒæ•¸å„ªåŒ–çµæœ
            
            ### ğŸ“Š åŸ·è¡Œè³‡è¨Š
            - **Workflow Run:** [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **ç­–ç•¥:** ${{ github.event.inputs.strategy || 'all' }}
            - **å›æ¸¬å¤©æ•¸:** ${{ github.event.inputs.days || '60' }}
            - **åŸ·è¡Œæ™‚é–“:** $(date +'%Y-%m-%d %H:%M:%S')
            
            ### ğŸ“ è®Šæ›´æª”æ¡ˆ
            - `optimized_params.json` - æ›´æ–°çš„æœ€ä½³åƒæ•¸
            - `optimization_report.md` - è©³ç´°å„ªåŒ–å ±å‘Š
            
            ### âœ… å¾ŒçºŒæ­¥é©Ÿ
            1. ğŸ“¥ ä¸‹è¼‰ [Artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) æŸ¥çœ‹å®Œæ•´çµæœ
            2. ğŸ“– é–±è®€ `optimization_report.md` äº†è§£å„ªåŒ–è©³æƒ…
            3. ğŸ§ª æ¸¬è©¦æ–°åƒæ•¸ï¼š`python qqq_analyzer.py --show-params`
            4. âœ… ç¢ºèªç„¡èª¤å¾Œåˆä½µæ­¤ PR
            5. ğŸ“ˆ è§€å¯Ÿç­–ç•¥è¡¨ç¾æ•¸å¤©
            
            ### âš ï¸ æ³¨æ„äº‹é …
            - åˆä½µå‰è«‹ç¢ºèªåƒæ•¸åˆç†æ€§
            - å»ºè­°å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰
            - å¯ä»¥ä¿®æ”¹åƒæ•¸å¾Œå†æäº¤
            
            ---
            ğŸ¤– *æ­¤ Pull Request ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ*
          labels: |
            optimization
            automated
            needs-review
          draft: false
          add-paths: |
            optimized_params.json
            optimization_report.md
      
      - name: ğŸ’¬ Post summary comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ğŸ¯ å„ªåŒ–å®Œæˆ\n\n';
            
            try {
              if (fs.existsSync('optimization_report.md')) {
                const report = fs.readFileSync('optimization_report.md', 'utf8');
                comment += report;
              }
            } catch (e) {
              comment += 'ç„¡æ³•è®€å–å„ªåŒ–å ±å‘Š';
            }
            
            // å¦‚æœæ˜¯ PRï¼Œåœ¨ PR ä¸Šç•™è¨€
            if (context.payload.pull_request) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }
      
      - name: ğŸš¨ Notify on failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="âŒ *åƒæ•¸å„ªåŒ–å¤±æ•—*%0A%0AWorkflow: ${{ github.workflow }}%0ARun: ${{ github.run_number }}%0A%0AğŸ”— [æŸ¥çœ‹è©³æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
              -d parse_mode="Markdown"
          fi
