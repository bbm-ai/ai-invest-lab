name: QQQ Parameter Optimization

on:
  # æ¯æœˆç¬¬ä¸€å€‹é€±å…­åŸ·è¡Œ
  schedule:
    - cron: '0 10 1-7 * 6'  # UTC 10:00 on first Saturday of month
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      strategy:
        description: 'ç­–ç•¥ (ma20, default, all)'
        required: false
        default: 'all'
      days:
        description: 'å›æ¸¬å¤©æ•¸'
        required: false
        default: '60'
      dry_run:
        description: 'æ¨¡æ“¬åŸ·è¡Œ (true/false)'
        required: false
        default: 'false'

jobs:
  optimize:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ” Run optimization
        env:
          GAS_URL: ${{ secrets.GAS_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STRATEGY="${{ github.event.inputs.strategy || 'all' }}"
          DAYS="${{ github.event.inputs.days || '60' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          
          if [ "$DRY_RUN" == "true" ]; then
            python auto_optimize.py --strategy $STRATEGY --days $DAYS --dry-run
          else
            python auto_optimize.py --strategy $STRATEGY --days $DAYS
          fi
      
      - name: ğŸ“Š Generate optimization report
        if: success()
        run: |
          echo "# Optimization Report" > optimization_report.md
          echo "" >> optimization_report.md
          echo "**Date:** $(date)" >> optimization_report.md
          echo "**Strategy:** ${{ github.event.inputs.strategy || 'all' }}" >> optimization_report.md
          echo "**Days:** ${{ github.event.inputs.days || '60' }}" >> optimization_report.md
          echo "" >> optimization_report.md
          
          if [ -f "optimization_results.json" ]; then
            echo "## Results" >> optimization_report.md
            echo '```json' >> optimization_report.md
            cat optimization_results.json >> optimization_report.md
            echo '```' >> optimization_report.md
          fi
      
      - name: ğŸ’¾ Commit updated parameters
        if: ${{ github.event.inputs.dry_run != 'true' && success() }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -f "optimized_params.json" ]; then
            git add optimized_params.json
            git commit -m "ğŸ¤– Auto-update optimized parameters - $(date +'%Y-%m-%d')" || echo "No changes to commit"
            git push || echo "Nothing to push"
          fi
      
      - name: ğŸ’¾ Upload optimization results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: optimization-results-${{ github.run_number }}
          path: |
            optimized_params.json
            optimization_results.json
            *.log
            optimization_report.md
          retention-days: 90
      
      - name: ğŸ“‹ Create Pull Request (for review)
        if: ${{ github.event.inputs.dry_run != 'true' && success() }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Update optimized parameters'
          title: 'ğŸ¤– Optimized Parameters Update - ${{ github.run_number }}'
          body: |
            ## åƒæ•¸å„ªåŒ–çµæœ
            
            **åŸ·è¡Œæ™‚é–“:** ${{ github.run_number }}
            **ç­–ç•¥:** ${{ github.event.inputs.strategy || 'all' }}
            **å›æ¸¬å¤©æ•¸:** ${{ github.event.inputs.days || '60' }}
            
            ### è®Šæ›´å…§å®¹
            - æ›´æ–° `optimized_params.json`
            
            ### å¾ŒçºŒæ­¥é©Ÿ
            1. æŸ¥çœ‹å„ªåŒ–çµæœ
            2. é©—è­‰åƒæ•¸åˆç†æ€§
            3. åˆä½µæ­¤ PR ä»¥æ¡ç”¨æ–°åƒæ•¸
            
            ---
            *æ­¤ PR ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ*
          branch: optimization-update-${{ github.run_number }}
          delete-branch: true
          labels: |
            optimization
            automated
