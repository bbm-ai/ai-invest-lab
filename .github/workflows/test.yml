name: Test QQQ System

# Âè™ËÉΩÊâãÂãïËß∏ÁôºÔºåÁî®ÊñºÊ∏¨Ë©¶
on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Ê∏¨Ë©¶È°ûÂûã'
        required: true
        type: choice
        options:
          - 'quick-test'
          - 'full-test'
          - 'connection-test'
      strategy:
        description: 'Á≠ñÁï• (default/ma20)'
        required: false
        default: 'default'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: üîç Connection Test
        if: ${{ github.event.inputs.test_type == 'connection-test' }}
        env:
          GAS_URL: ${{ secrets.GAS_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "Testing environment variables..."
          
          # Test GAS URL
          if [ -z "$GAS_URL" ]; then
            echo "‚ùå GAS_URL is not set"
            exit 1
          else
            echo "‚úÖ GAS_URL is set"
          fi
          
          # Test Telegram
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "‚ö†Ô∏è Telegram credentials not set (optional)"
          else
            echo "‚úÖ Telegram credentials are set"
            
            # Send test message
            curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="üß™ GitHub Actions Ê∏¨Ë©¶Ë®äÊÅØ%0A%0AÊôÇÈñì: $(date)%0AWorkflow: Test" \
              -d parse_mode="Markdown" || echo "Failed to send Telegram message"
          fi
          
          echo ""
          echo "Environment test completed!"
      
      - name: ‚ö° Quick Test
        if: ${{ github.event.inputs.test_type == 'quick-test' }}
        env:
          GAS_URL: ${{ secrets.GAS_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STRATEGY: ${{ github.event.inputs.strategy }}
        run: |
          echo "Running quick test..."
          python qqq_analyzer.py --show-params
          echo ""
          echo "‚úÖ Quick test passed!"
      
      - name: üß™ Full Test
        if: ${{ github.event.inputs.test_type == 'full-test' }}
        env:
          GAS_URL: ${{ secrets.GAS_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STRATEGY: ${{ github.event.inputs.strategy }}
        run: |
          echo "Running full analysis..."
          python qqq_analyzer.py --strategy $STRATEGY
          
          if [ -f "output.json" ]; then
            echo "‚úÖ output.json generated"
            cat output.json
          else
            echo "‚ùå output.json not found"
            exit 1
          fi
      
      - name: üìä Display System Info
        run: |
          echo "=== System Information ==="
          echo "Python version: $(python --version)"
          echo "Pip version: $(pip --version)"
          echo ""
          echo "=== Installed Packages ==="
          pip list
          echo ""
          echo "=== Disk Usage ==="
          df -h
      
      - name: üíæ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_number }}
          path: |
            output.json
            *.log
          retention-days: 7
      
      - name: ‚úÖ Test Summary
        if: success()
        run: |
          echo "================================"
          echo "‚úÖ All tests passed!"
          echo "================================"
          echo ""
          echo "Test Type: ${{ github.event.inputs.test_type }}"
          echo "Strategy: ${{ github.event.inputs.strategy }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Timestamp: $(date)"
          echo ""
          echo "Next steps:"
          echo "1. Check the artifacts for output files"
          echo "2. Verify Telegram notification (if sent)"
          echo "3. Check Google Sheets for data"
